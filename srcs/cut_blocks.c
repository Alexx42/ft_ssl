/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   cut_blocks.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: ale-goff <ale-goff@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2019/04/02 16:33:36 by ale-goff          #+#    #+#             */
/*   Updated: 2019/04/03 13:31:26 by ale-goff         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include <ft_ssl.h>

uint32_t g_r[] = {7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22,
	5, 9, 14, 20, 5, 9, 14, 20, 5, 9, 14, 20, 5, 9, 14, 20,
	4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23,
	6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21};

uint32_t g_k[64] = {
74957514, 149892196, 224781220, 299601773, 374331064, 448946331, 523424844, 597743917,      //0-7
671880911,745813244, 819518394, 892973912, 966157421, 1039046629, 1111629334, 1183853428,   //8-15
1255726910, 1327217884, 1398304576, 1468965330, 1539178623, 1608923067, 1678177418, 1746920580, //16-23
1815131612, 1882789738, 1949874349, 2016365008, 2082241463, 2147483648, 2212071687, 2275985909, //24-31
2339206843, 2401715232, 2463492035, 2524518435, 2584775842, 2644245901, 2702910498, 2760751761, //32-39
2817752073, 2873894071, 2929160652, 2983534983, 3037000499, 3089540917, 3141140230, 3191782721, //40-47
3241452965, 3290135830, 3337816488, 3384480415, 3430113397, 3474701532, 3518231240, 3560689261, //48-55
3602062661, 3642338838, 3681505523, 3719550786, 3756463038, 3792231035, 3826843881, 3860291034};//56-63

uint32_t g_w[16] = {0};

uint32_t g_h[4] = {0x67452301,0xEFCDAB89,0x98BADCFE,0x10325476};

t_hash	*init_hash()
{
	t_hash	*hash;

	hash = (t_hash*)malloc(sizeof(t_hash));
	if (hash == NULL)
		return (NULL);
	hash->a = g_h[0];
	hash->b = g_h[1];
	hash->c = g_h[2];
	hash->d = g_h[3];
	return (hash);
}

void	main_loop(t_hash *hash, uint32_t *w, int i)
{
	int		f;
	int		g;
	int		tmp;

	if (i >= 0 && i <= 15)
	{
		f = f_func(hash->b, hash->c, hash->d);
		g = i;
	}
	else if (i >= 16 && i <= 31)
	{
		f = g_func(hash->b, hash->c, hash->d);
		g = (5 * i + 1) % 16;
	}
	else if (i >= 32 && i <= 47)
	{
		f = h_func(hash->b, hash->c, hash->d);
		g = (3 * i + 5) % 16;
	}
	else
	{
		f = i_func(hash->b, hash->c, hash->d);
		g = (7 * i) % 16;
	}
	tmp = hash->d;
	hash->d = hash->c;
	hash->c = hash->b;
	hash->b = ROTATE_LEFT(hash->a + f + g_k[i] + w[g], g_r[i]) + hash->b;
	hash->a = tmp;
	// a : les 3 premiers
	// b : 0
	// c : le premier
	// d : les 2 premiers
}


void	cut_blocks(t_md5 *md5, t_ssl *ssl, int new_len)
{
	t_hash		*hash;
	int			offset;
	uint32_t	*w;
	int			i;

	(void)ssl;
	offset = 0;
	while (offset < new_len)
	{
		w = (uint32_t*)(md5->message + offset);
		hash = init_hash();
		i = -1;
		while (++i < 64)
			main_loop(hash, w, i);
		g_h[0] += hash->a;
		g_h[1] += hash->b;
		g_h[2] += hash->c; 	
		g_h[3] += hash->d; 	
		offset += 64;
	}
	printf("%02x", g_h[0]);
	// printf("%02x", g_h[1]);
	// printf("%02x", g_h[2]);
	// printf("%02x", g_h[3]);

}